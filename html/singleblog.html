<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    
    <link rel="stylesheet" href="css/singleblog.css" />
     <link rel="website icon" href="image/logo.png" />
    <title>blog</title>
  </head>
  <body>
    <main class="nav-bar">
      <div id="nav-img">
        <img src="image/logo.png" alt="#" />
      </div>
      <div class="topnav">
        <div id="menu">
          <li style="--i: 0"><a href="#">science</a></li>
          <li style="--i: 1"><a href="#">nature</a></li>
          <li style="--i: 2"><a href="#">football</a></li>
          <li style="--i: 3"><a href="#">movies</a></li>
        </div>
        <a href="javascript:void(0);" class="icon" onclick="myFunction()">
          <i class="fa fa-bars"></i
        ></a>
      </div>
    </main>
    <!-- section part start -->
    <section>
    <div>
      <div class="ftb">
      </div>
      <div class="comment">
        <div id="display-comment">
        </div>
        <div id="add-comment">
            <input
              type="text"
              name="comment"
              id="comments"
              placeholder="add comment"
            />
            <button onclick="validateComment()">comment</button>
          </div>
        </div>
      </div>
      <div id="error">Your name or comment can not be empty</div>
    </div>
  </section>
    <!-- section part end -->
    <footer>
      <div id="copy">
        <p>&copy /2022</p>
        <hr />
      </div>
      <div id="icons">
        <a href="https://github.com/rwamugema"> <i class="fa fa-github"></i></a>
        <a href="https://www.linkedin.com/in/rwamugema-japhet-84818b251/"
          ><i class="fa fa-linkedin"></i
        ></a>
        <a href="https://www.facebook.com/jet.japheth"
          ><i class="fa fa-facebook"></i
        ></a>
      </div>
    </footer>
    <script>
      //function to manage the humberg button
      function myFunction() {
        var x = document.getElementById("menu");
        if (x.style.display === "block") {
          x.style.display = "none";
        } else {
          x.style.display = "block";
        }
      }
      function likeFunction(x) {
      
}
      // validate user inputs on the front side
    
     async  function validateComment() {
    const token = localStorage.getItem('token')
    const urlParams = new URL(window.location).searchParams;
    const nameId = urlParams.get("id");
        var comments = [];
        let comment = {
          // userName: document.getElementsByName("name")[0].value,
          comment: document.getElementsByName("comment")[0].value,
        };
        // check user inputs
       if (!comment.comment) {
          error.style.display = "block";
          error.innerHTML = "comment is required";
        } else if (comment.comment.length < 5) {
          error.style.display = "block";
          error.style.display = "comment is short try 5 words ";
        } else {
          const accessToken =JSON.parse(localStorage.getItem('user'))
          const token = accessToken[0].token
          const options = {
            method: 'POST',
            headers:{
              Authorization: `bearer ${token}`,
              'content-type':'application/json'
            },
            body:JSON.stringify(comment)
          }
          const response = await fetch(`https://naughty-jay-tank-top.cyclic.app/api/v1/blogs/${nameId}/comment/create`,options)
          const data = await response.json()
          location.reload()
        } 

      }
         displayFullBlog();
// display blog with associated comments
async  function displayFullBlog() {
 const urlParams = new URL(window.location).searchParams;
 const nameId = urlParams.get("id");
 const response = await fetch('https://naughty-jay-tank-top.cyclic.app/api/v1/blogs')
 const data = await response.json()
 const comments= await fetch(`https://naughty-jay-tank-top.cyclic.app/api/v1/blogs/${nameId}/comment`)
  const c = await comments.json()
 let post = data.filter((e)=> e._id == nameId)
 let section = document.querySelector(".ftb");
 let displayPost= document.createElement('div')
 console.log(data);

 //display single blog

  post.forEach(element => {
    displayPost.innerHTML = `
  <div class="ftb">
    <div id="head">
      <h2>${element.category}</h2>
      <h2>${element.title}</h2>
    </div>
    <div class="cont-ner">
  <img src="${element.image}" alt="" class="article-image" />
  <div id="contents">
  <div id="likePost">
    <span><i onclick="likeFunction(this)" class="fa fa-thumbs-up"></i>${element.likes}</span>
    <p><i class='fa fa-comment' onclick="comment()"></i>${c.length}</p>
    </div>
    <p>${element.content}</p>
    </div>
    </div>
  </div>
  `
  });
  section.append(displayPost);
}
 //display comments

        async function displayComment(){
          let name = JSON.parse(localStorage.getItem('user'))
          let userName = name[0].userName
          const urlParams = new URL(window.location).searchParams;
         const nameId = urlParams.get("id");
         const comments= await fetch(`https://naughty-jay-tank-top.cyclic.app/api/v1/blogs/${nameId}/comment`)
         const c = await comments.json()
         let commentDisplayer = document.querySelector("#display-comment")
          let displayComment = document.createElement('div')
          c.forEach(element => {
               displayComment=` 
               <span>${userName}</span>
          <p>${element.comment}</p>
          </div>
           `
           commentDisplayer.innerHTML +=displayComment
          });
        }
        async function likeFunction(x){
          const accessToken =JSON.parse(localStorage.getItem('user'))
          const token = accessToken[0].token
          const urlParams = new URL(window.location).searchParams;
          const nameId = urlParams.get("id");
          const response =  await fetch(`https://naughty-jay-tank-top.cyclic.app/api/v1/blogs/${nameId}/likes`,{
          method:'POST',
          headers:{
            Authorization: `bearer ${token}`
          }
         })
         location.reload()
        }

        //toggle hide/show comment session
        
       function comment(){
        let commentDiv = document.querySelector('.comment')
         if (commentDiv.style.display === 'none') {
          commentDiv.style.display = 'block'
         }else{
          commentDiv.style.display = 'none'
         }
        }
        //call display comment method
        displayComment()
    </script>
  </body>
</html>
